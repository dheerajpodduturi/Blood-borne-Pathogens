<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bloodborne Pathogens Safety ‚Äî SCORM 1.2</title>
  <meta name="description" content="SCORM 1.2 compatible Bloodborne Pathogens course aligned to OSHA 29 CFR 1910.1030." />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --border: rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 14px 44px rgba(15,23,42,.10);

      --teal:#0ea5a4;
      --teal2:#0b8a89;
      --ok:#22c55e;
      --danger:#ef4444;

      --r20: 20px;
      --navH: 70px;

      /* ‚úÖ wider like your screenshot */
      --max: 1440px;

      --ease: cubic-bezier(.2,.8,.2,1);
      --dur: 420ms;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 450px at 40% 0%, rgba(14,165,164,.14), transparent 55%),
        radial-gradient(700px 380px at 90% 4%, rgba(59,130,246,.10), transparent 55%),
        var(--bg);
      line-height:1.55;
    }

    a{color:var(--teal2); text-underline-offset: 3px}
    a:focus-visible, button:focus-visible, [role="button"]:focus-visible, input:focus-visible{
      outline:3px solid rgba(14,165,164,.35);
      outline-offset:3px;
      border-radius:12px;
    }

    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Top Nav */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--navH);
      display:flex; align-items:center;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
      z-index:1000;
    }
    .topbar__inner{
      width:min(var(--max), calc(100% - 32px));
      margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:-.02em;
    }
    .brand__dot{
      width:10px; height:10px; border-radius:999px; background:var(--teal);
      box-shadow: 0 0 0 6px rgba(14,165,164,.12);
    }
    .topbar__right{display:flex; align-items:center; gap:12px;}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(14,165,164,.35);
      background: rgba(14,165,164,.08);
      color: #0b6f6e;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }
    .avatar{
      width:36px; height:36px; border-radius:999px;
      overflow:hidden;
      border:2px solid rgba(14,165,164,.25);
      box-shadow: var(--shadow);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), transparent 55%),
        linear-gradient(135deg, rgba(14,165,164,.55), rgba(59,130,246,.35));
      display:grid; place-items:center;
      font-weight:800; color:#0b3b3a;
    }

    /* Progress bar */
    .progressStrip{
      position:fixed; top:0; left:0; right:0;
      height:4px; background: transparent;
      z-index:1001;
    }
    .progressStrip > span{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, var(--teal), #22c55e);
      transition: width 120ms linear;
    }

    /* Layout */
    main{
      padding-top: calc(var(--navH) + 26px);
      padding-bottom: 70px;
    }

    .wrap{
      width:min(var(--max), calc(100% - 32px));
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr 300px;
      gap:28px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .sideNav{ position:static !important; }
    }

    section{ margin: 0 0 26px; }
    .hero{ padding: 22px 0 10px; }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:16px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-weight:700;
      font-size:13px;
      color: var(--muted);
    }
    .chip svg{ width:16px; height:16px; color: var(--teal); }

    h1{
      margin:0;
      font-size: clamp(34px, 4vw, 54px);
      letter-spacing: -0.03em;
      line-height:1.08;
    }
    .lead{
      margin: 14px 0 0;
      max-width: 80ch;
      font-size: 16.5px;
      color: var(--muted);
    }

    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--r20);
      box-shadow: var(--shadow);
      width:100%;
    }
    .pad{ padding: 22px; }

    /* Video */
    .videoFrame{
      width:100%;
      aspect-ratio: 16/9;
      border-radius: 18px;
      overflow:hidden;
      background: #0b1220;
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .videoFrame iframe{ width:100%; height:100%; border:0; }
    .videoMeta{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding-top: 14px;
      border-top: 1px solid rgba(15,23,42,.08);
      margin-top: 14px;
      color: var(--muted2);
      font-size: 13px;
    }
    .checkboxLine{
      display:flex; align-items:center; gap:10px;
      color: var(--muted);
      font-weight:700;
    }
    .checkboxLine input{ width:18px; height:18px; accent-color: var(--teal); }

    .tag{
      display:inline-flex; align-items:center;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size: 13px;
      background: rgba(14,165,164,.12);
      color: #0b6f6e;
    }
    .qTitle{
      margin: 10px 0 0;
      font-size: 26px;
      line-height:1.15;
      letter-spacing:-.02em;
    }

    /* Knowledge check (premium selected + enabled submit) */
    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top: 18px;
    }
    @media (max-width: 720px){
      .options{ grid-template-columns: 1fr; }
    }
    .opt{
      position: relative;
      display:flex; gap:12px; align-items:center;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      box-shadow: 0 6px 18px rgba(15,23,42,.05);
      cursor:pointer;
      transition: transform 220ms var(--ease), box-shadow 220ms var(--ease), border-color 220ms var(--ease), background 220ms var(--ease);
      user-select:none;
      min-height: 68px;
    }
    .opt:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(15,23,42,.08);
    }
    .opt[data-selected="true"]{
      border-color: rgba(14,165,164,.95);
      background: rgba(14,165,164,.08);
      box-shadow:
        0 14px 34px rgba(14,165,164,.14),
        0 0 0 2px rgba(14,165,164,.28);
    }
    .opt[data-selected="true"]::before{
      content:"";
      position:absolute;
      left:0; top:10px; bottom:10px;
      width:6px;
      border-radius: 999px;
      background: linear-gradient(180deg, #0ea5a4, #22c55e);
    }
    .optLetter{
      width:34px; height:34px; border-radius:999px;
      background: rgba(15,23,42,.05);
      display:grid; place-items:center;
      font-weight:900;
      color: var(--muted);
      flex:0 0 auto;
    }
    .opt[data-selected="true"] .optLetter{
      background: #0b8a89;
      color:#fff;
      box-shadow: 0 10px 20px rgba(11,138,137,.18);
    }
    .optText{ font-weight:800; color: var(--ink); }

    .btnPrimary{
      width:100%;
      margin-top: 18px;
      border:0;
      border-radius: 10px;
      padding: 14px 16px;
      background: rgba(14,165,164,.35);
      color: #ffffff;
      font-weight: 900;
      font-size: 15px;
      cursor:not-allowed;
      transition: background 220ms var(--ease), transform 220ms var(--ease), filter 220ms var(--ease);
    }
    .btnPrimary.is-enabled{
      background: #0b8a89;
      cursor:pointer;
    }
    .btnPrimary.is-enabled:hover{
      filter: brightness(1.04);
      transform: translateY(-1px);
    }
    .btnPrimary:disabled{ opacity: 1; }

    .feedback{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      color: var(--muted);
      font-weight: 700;
    }
    .feedback.good{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); color: #166534; }
    .feedback.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); color: #7f1d1d; }

    /* ‚úÖ Activity EXACT style (no extra buttons) */
    .activityHeader{ display:grid; gap:6px; margin-bottom: 12px; }

    .activityGrid{
      display:grid;
      grid-template-columns: 260px 1fr 1fr;
      gap: 22px;
      align-items:start;
      margin-top: 16px;
      width:100%;
    }
    @media (max-width: 1100px){
      .activityGrid{ grid-template-columns: 1fr; }
    }

    .itemsTitle{
      margin:6px 0 10px;
      font-size:14px;
      color:var(--muted);
      font-weight:900;
    }
    .itemList{ display:grid; gap:12px; }

    .dndItem{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      box-shadow: 0 8px 22px rgba(15,23,42,.06);
      cursor: grab;
      user-select:none;
    }
    .dndItem:active{ cursor: grabbing; }
    .grip{
      width:34px; height:34px;
      border-radius: 10px;
      background: rgba(15,23,42,.05);
      display:grid;
      place-items:center;
      color: var(--muted2);
      flex:0 0 auto;
      font-weight:900;
      line-height:1;
    }
    .dndText{
      font-weight:800;
      color: var(--ink);
      font-size: 14px;
      line-height: 1.2;
    }

    .dropZone{
      border: 2px dashed rgba(100,116,139,.45);
      border-radius: 14px;
      background: transparent;
      padding: 14px;
      min-height: 280px;
      transition: border-color 180ms var(--ease), background 180ms var(--ease), box-shadow 180ms var(--ease);
    }
    .dropZoneTitle{
      margin: 6px 0 12px;
      font-size: 14px;
      color: var(--ink);
      font-weight:900;
    }
    .dropZone.dragOver{
      border-color: rgba(14,165,164,.85);
      background: rgba(14,165,164,.06);
      box-shadow: 0 0 0 4px rgba(14,165,164,.10);
    }

    .activityFooter{
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(15,23,42,.08);
    }

    .markCompleteRow{
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top: 12px;
    }
    .secondaryBtn{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius:12px;
      padding: 12px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .secondaryBtn:hover{
      border-color: rgba(14,165,164,.35);
      background: rgba(14,165,164,.05);
      color:#0b6f6e;
    }
    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.9);
      color: var(--muted);
      font-weight:900;
    }

    /* Side nav */
    .sideNav{
      position: sticky;
      top: calc(var(--navH) + 18px);
    }
    .sideCard{
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow2);
      padding: 12px;
    }
    .navList{ margin:0; padding:0; list-style:none; display:grid; gap:6px; }
    .navItem a{
      display:flex; align-items:center; gap:10px;
      padding: 10px 10px;
      border-radius: 12px;
      text-decoration:none;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
    }
    .navItem a:hover{ background: rgba(14,165,164,.08); color:#0b6f6e; }
    .navItem a[aria-current="true"]{ background: rgba(14,165,164,.10); color:#0b6f6e; }
    .bullet{ width:8px; height:8px; border-radius:999px; background: rgba(100,116,139,.35); }
    .navItem a[aria-current="true"] .bullet{ background: var(--teal); box-shadow: 0 0 0 6px rgba(14,165,164,.12); }

    /* reveal */
    .reveal{ opacity:0; transform: translateY(14px); transition: opacity var(--dur) var(--ease), transform var(--dur) var(--ease); }
    .reveal.in{ opacity:1; transform:none; }
  </style>
</head>

<body>
  <div class="progressStrip" aria-hidden="true"><span id="progressBar"></span></div>

  <header class="topbar" role="banner">
    <div class="topbar__inner">
      <div class="brand" aria-label="Course title">
        <span class="brand__dot" aria-hidden="true"></span>
        <span>Bloodborne Pathogens Safety</span>
      </div>

      <div class="topbar__right">
        <div class="pill" aria-live="polite" aria-atomic="true">
          <span id="pct">0%</span> Complete
        </div>
        <div class="avatar" aria-label="Learner profile" title="Learner">
          <span aria-hidden="true">üë©‚Äç‚öïÔ∏è</span>
        </div>
      </div>
    </div>
  </header>

  <main id="main" role="main">
    <div class="wrap">
      <!-- CONTENT -->
      <div>

        <!-- HERO -->
        <section class="hero reveal" id="intro" data-section="Intro">
          <div class="chips" aria-label="Course metadata">
            <div class="chip">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 7v5l3 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span>~12 min</span>
            </div>
            <div class="chip">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M16 11a4 4 0 1 0-8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 20c1.6-3 4.3-5 8-5s6.4 2 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>Required ‚Äî All Clinical Staff</span>
            </div>
          </div>

          <h1>Module: Exposure Prevention &amp;<br/>Standard Precautions</h1>
          <p class="lead">
            Learn the critical protocols for minimizing exposure to bloodborne pathogens including proper PPE selection,
            hand hygiene, and safe sharps handling ‚Äî aligned to OSHA 29 CFR 1910.1030.
          </p>
        </section>

        <!-- VIDEO -->
        <section class="reveal" id="video" data-section="Video">
          <div class="card pad">
            <div class="videoFrame" aria-label="Training video">
              <iframe
                title="Bloodborne Pathogens Training Video"
                src="https://www.youtube.com/embed/2R4n8k7tY4o"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen></iframe>
            </div>

            <h2 style="margin:16px 0 6px; letter-spacing:-.02em;">Understanding the Chain of Infection</h2>
            <div class="videoMeta">
              <span aria-label="Video duration">4:32</span>
              <label class="checkboxLine">
                <input id="markVideo" type="checkbox" />
                Mark as complete
              </label>
            </div>
          </div>
        </section>

        <!-- KNOWLEDGE CHECK -->
        <section class="reveal" id="knowledge-check" data-section="Knowledge Check">
          <div class="card pad">
            <span class="tag">Knowledge Check</span>
            <h2 class="qTitle">A healthcare worker sustains a needlestick injury. What is the <u>FIRST</u> action they should take?</h2>

            <div class="options" role="radiogroup" aria-label="Question 1 options" data-qid="q1">
              <div class="opt" role="radio" tabindex="0" aria-checked="false" data-opt="A">
                <div class="optLetter" aria-hidden="true">A</div>
                <div class="optText">File an incident report</div>
              </div>
              <div class="opt" role="radio" tabindex="0" aria-checked="false" data-opt="B">
                <div class="optLetter" aria-hidden="true">B</div>
                <div class="optText">Wash the area immediately with soap and water</div>
              </div>
              <div class="opt" role="radio" tabindex="0" aria-checked="false" data-opt="C">
                <div class="optLetter" aria-hidden="true">C</div>
                <div class="optText">Apply a bandage and continue working</div>
              </div>
              <div class="opt" role="radio" tabindex="0" aria-checked="false" data-opt="D">
                <div class="optLetter" aria-hidden="true">D</div>
                <div class="optText">Notify a supervisor</div>
              </div>
            </div>

            <button class="btnPrimary" id="submitQ1" type="button" disabled>Submit Answer</button>
            <div class="feedback" id="fbQ1" role="status" aria-live="polite" hidden></div>
          </div>
        </section>

        <!-- ACTIVITY -->
        <section class="reveal" id="activity" data-section="Activity">
          <div class="card pad">
            <div class="activityHeader">
              <span class="tag">Interactive Activity</span>
              <h2 class="qTitle" style="margin-top:0;">
                Classify each action as a Standard Precaution or a Transmission-Based Precaution
              </h2>
              <p class="lead" style="margin-top:0;">
                Drag items from the left to the appropriate category on the right
              </p>
            </div>

            <div class="activityGrid" aria-label="Classification activity">
              <div>
                <div class="itemsTitle">Items to Sort</div>
                <div class="itemList" id="pool" aria-label="Items to sort"></div>
              </div>

              <div class="dropZone" id="zoneStandard" aria-label="Standard Precautions drop zone">
                <div class="dropZoneTitle">Standard Precautions</div>
                <div class="itemList" id="bucketStandard"></div>
              </div>

              <div class="dropZone" id="zoneTransmission" aria-label="Transmission-Based Precautions drop zone">
                <div class="dropZoneTitle">Transmission-Based Precautions</div>
                <div class="itemList" id="bucketTransmission"></div>
              </div>
            </div>

            <div class="activityFooter">
              <button class="btnPrimary is-enabled" id="checkActivity" type="button">Check My Answers</button>
              <div class="feedback" id="fbAct" role="status" aria-live="polite" hidden></div>

              <div class="markCompleteRow">
                <button class="secondaryBtn" id="markCompleteBtn" type="button">Mark Complete</button>
                <div class="statusPill" aria-live="polite">
                  Status: <span id="statusText">incomplete</span> ‚Ä¢ Score: <span id="scoreText">0%</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- REFERENCE (so you see content after activity) -->
        <section class="reveal" id="reference" data-section="Reference">
          <div class="card pad">
            <span class="tag">Reference</span>
            <h2 class="qTitle" style="margin-top:10px;">Quick reminders</h2>
            <p class="lead" style="margin-top:10px;">
              Standard Precautions apply to all patients. Transmission-Based Precautions are added when infection is known or suspected.
              Follow your facility‚Äôs Exposure Control Plan and OSHA 29 CFR 1910.1030 requirements.
            </p>
            <ul style="margin:12px 0 0; color:var(--muted); font-weight:700;">
              <li>Wash/flush immediately after exposure.</li>
              <li>Report and seek medical evaluation promptly.</li>
              <li>Use PPE appropriate to task and risk.</li>
              <li>Dispose of sharps in approved puncture-resistant containers.</li>
            </ul>
          </div>
        </section>

        <!-- COMPLETE -->
        <section class="reveal" id="complete" data-section="Complete">
          <div class="card pad">
            <span class="tag">Complete</span>
            <h2 class="qTitle" style="margin-top:10px;">End of module</h2>
            <p class="lead" style="margin-top:10px;">
              To complete: scroll to the bottom (done if you're here) and pass the knowledge check (‚â•70%), then click <b>Mark Complete</b>.
            </p>
          </div>
        </section>

      </div>

      <!-- SIDE NAV -->
      <aside class="sideNav" aria-label="Lesson navigation">
        <div class="sideCard">
          <ul class="navList" id="lessonNav">
            <li class="navItem"><a href="#intro" data-link="Intro"><span class="bullet" aria-hidden="true"></span>Intro</a></li>
            <li class="navItem"><a href="#video" data-link="Video"><span class="bullet" aria-hidden="true"></span>Video</a></li>
            <li class="navItem"><a href="#knowledge-check" data-link="Knowledge Check"><span class="bullet" aria-hidden="true"></span>Knowledge<br/>Check</a></li>
            <li class="navItem"><a href="#activity" data-link="Activity"><span class="bullet" aria-hidden="true"></span>Activity</a></li>
            <li class="navItem"><a href="#reference" data-link="Reference"><span class="bullet" aria-hidden="true"></span>Reference</a></li>
            <li class="navItem"><a href="#complete" data-link="Complete"><span class="bullet" aria-hidden="true"></span>Complete</a></li>
          </ul>
        </div>
      </aside>
    </div>
  </main>

  <script>
    /***********************
     * SCORM 1.2 Wrapper
     ***********************/
    const SCORM = (function(){
      let api = null;
      let connected = false;

      function findAPI(win){
        let attempts = 0;
        while(win && attempts < 500){
          if(win.API) return win.API;
          attempts++;
          win = win.parent;
        }
        return null;
      }
      function init(){
        api = findAPI(window);
        if(!api){
          console.warn("[SCORM] API not found. Standalone mode.");
          return false;
        }
        connected = api.LMSInitialize("") === "true";
        return connected;
      }
      function getValue(k){
        if(!connected) return "";
        return api.LMSGetValue(k);
      }
      function setValue(k,v){
        if(!connected){
          console.log("[SCORM] set", k, v);
          return true;
        }
        return api.LMSSetValue(k, String(v)) === "true";
      }
      function commit(){
        if(!connected){
          console.log("[SCORM] commit");
          return true;
        }
        return api.LMSCommit("") === "true";
      }
      function finish(){
        if(!connected){
          console.log("[SCORM] finish");
          return true;
        }
        return api.LMSFinish("") === "true";
      }
      return { init, getValue, setValue, commit, finish, isConnected:()=>connected };
    })();

    function msToSCORMTime(ms){
      const totalSeconds = Math.max(0, Math.floor(ms/1000));
      const hh = String(Math.floor(totalSeconds/3600)).padStart(2,"0");
      const mm = String(Math.floor((totalSeconds%3600)/60)).padStart(2,"0");
      const ss = String(totalSeconds%60).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    /***********************
     * State
     ***********************/
    const STORE_KEY = "bbp_scorm_state_fixed_v1";
    const state = loadState();

    function loadState(){
      try{
        return JSON.parse(localStorage.getItem(STORE_KEY)) || {
          startedAt: Date.now(),
          sectionTimeMs: {},
          currentSection: null,
          sectionEnteredAt: null,
          interactions: [],
          quiz: { q1: { attempts:0, selected:null, correct:null } },
          activity: { checked:false, correctCount:0, total:0, placement:{} },
          scoreRaw: 0,
          passed: false,
          scrolledBottom: false,
          status: "incomplete"
        };
      }catch(e){
        return {
          startedAt: Date.now(),
          sectionTimeMs: {},
          currentSection: null,
          sectionEnteredAt: null,
          interactions: [],
          quiz: { q1: { attempts:0, selected:null, correct:null } },
          activity: { checked:false, correctCount:0, total:0, placement:{} },
          scoreRaw: 0,
          passed: false,
          scrolledBottom: false,
          status: "incomplete"
        };
      }
    }
    function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
    function logInteraction(type, id, meta={}){
      state.interactions.push({ t: Date.now(), type, id, meta });
      saveState();
    }

    /***********************
     * Init SCORM
     ***********************/
    const scormConnected = SCORM.init();
    if(scormConnected){
      const existing = SCORM.getValue("cmi.core.lesson_status");
      if(existing && existing !== "not attempted"){
        state.status = existing;
      }else{
        SCORM.setValue("cmi.core.lesson_status", "incomplete");
        state.status = "incomplete";
        SCORM.commit();
      }
    }

    const statusText = document.getElementById("statusText");
    const scoreText  = document.getElementById("scoreText");
    statusText.textContent = state.status;
    scoreText.textContent = Math.round(state.scoreRaw) + "%";

    /***********************
     * Scroll progress + bottom detection
     ***********************/
    const progressBar = document.getElementById("progressBar");
    const pctEl = document.getElementById("pct");

    function updateProgress(){
      const doc = document.documentElement;
      const scrollTop = doc.scrollTop || document.body.scrollTop;
      const scrollHeight = doc.scrollHeight - doc.clientHeight;
      const p = scrollHeight > 0 ? Math.min(1, Math.max(0, scrollTop / scrollHeight)) : 0;
      const pct = Math.round(p * 100);
      progressBar.style.width = pct + "%";
      pctEl.textContent = pct + "%";
      if(pct >= 98){
        state.scrolledBottom = true;
        saveState();
      }
      return pct;
    }
    window.addEventListener("scroll", updateProgress, { passive:true });
    updateProgress();

    /***********************
     * Section timing + nav highlight
     ***********************/
    const sections = [...document.querySelectorAll("section[data-section]")];
    const navLinks = [...document.querySelectorAll("#lessonNav a")];

    function setCurrentNav(sectionName){
      navLinks.forEach(a => a.setAttribute("aria-current", a.dataset.link === sectionName ? "true" : "false"));
    }
    function commitSectionTime(nextSectionName){
      const now = Date.now();
      if(state.currentSection && state.sectionEnteredAt){
        const delta = now - state.sectionEnteredAt;
        state.sectionTimeMs[state.currentSection] = (state.sectionTimeMs[state.currentSection] || 0) + delta;
      }
      state.currentSection = nextSectionName;
      state.sectionEnteredAt = now;
      saveState();
    }

    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const name = entry.target.getAttribute("data-section");
          setCurrentNav(name);
          if(state.currentSection !== name) commitSectionTime(name);
        }
      });
    }, { threshold: 0.55 });
    sections.forEach(s => io.observe(s));

    /***********************
     * Reveal
     ***********************/
    const revealIO = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add("in"); });
    }, { threshold: 0.18 });
    document.querySelectorAll(".reveal").forEach(el => revealIO.observe(el));

    /***********************
     * Global click tracking
     ***********************/
    document.addEventListener("click", (e)=>{
      const t = e.target.closest("button,a,input,[role='radio']");
      if(!t) return;
      const id = t.id || t.getAttribute("href") || t.getAttribute("data-opt") || t.getAttribute("aria-label") || t.textContent.trim().slice(0,30);
      logInteraction("click", id, { tag: t.tagName.toLowerCase(), section: state.currentSection });
    }, true);

    /***********************
     * Video complete toggle
     ***********************/
    document.getElementById("markVideo").addEventListener("change", (e)=>{
      logInteraction("video_complete_toggle", "markVideo", { checked: e.target.checked });
    });

    /***********************
     * Knowledge Check Q1 (submit enabled only after selection)
     ***********************/
    const q1Correct = "B";
    const q1Opts = [...document.querySelectorAll(".options[data-qid='q1'] .opt")];
    const submitQ1 = document.getElementById("submitQ1");
    const fbQ1 = document.getElementById("fbQ1");

    submitQ1.disabled = true;
    submitQ1.classList.remove("is-enabled");

    function selectQ1(optEl){
      q1Opts.forEach(o=>{
        o.dataset.selected = "false";
        o.setAttribute("aria-checked","false");
      });
      optEl.dataset.selected = "true";
      optEl.setAttribute("aria-checked","true");

      state.quiz.q1.selected = optEl.dataset.opt;
      saveState();

      submitQ1.disabled = false;
      submitQ1.classList.add("is-enabled");
      logInteraction("quiz_select", "q1", { selected: state.quiz.q1.selected });
    }

    q1Opts.forEach(opt=>{
      opt.addEventListener("click", ()=>selectQ1(opt));
      opt.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          selectQ1(opt);
        }
      });
    });

    function recomputeScore(){
      const total = 1;
      const correct = state.quiz.q1.correct ? 1 : 0;
      state.scoreRaw = (correct/total) * 100;
      state.passed = state.scoreRaw >= 70;
      scoreText.textContent = Math.round(state.scoreRaw) + "%";
      saveState();
    }

    submitQ1.addEventListener("click", ()=>{
      if(!state.quiz.q1.selected){
        fbQ1.hidden = false;
        fbQ1.className = "feedback bad";
        fbQ1.textContent = "Please select an answer before submitting.";
        return;
      }
      state.quiz.q1.attempts += 1;
      const correct = state.quiz.q1.selected === q1Correct;
      state.quiz.q1.correct = correct;
      saveState();

      fbQ1.hidden = false;
      fbQ1.className = "feedback " + (correct ? "good" : "bad");
      fbQ1.textContent = correct
        ? "Correct. First, wash the area immediately with soap and water. Then report and follow your facility‚Äôs exposure protocol."
        : "Not quite. First step is immediate decontamination: wash the area with soap and water (or flush mucous membranes), then report.";

      logInteraction("quiz_submit", "q1", {
        question: "Needlestick: first action?",
        selected: state.quiz.q1.selected,
        correct,
        attempts: state.quiz.q1.attempts
      });

      recomputeScore();
      SCORM.setValue("cmi.core.score.raw", Math.round(state.scoreRaw));
      SCORM.setValue("cmi.core.score.min", 0);
      SCORM.setValue("cmi.core.score.max", 100);
      SCORM.commit();
    });

    /***********************
     * Activity: Drag & Drop (NO buttons) ‚Äî stable + no JS errors
     ***********************/
    const actItems = [
      { id:"i1", text:"Hand hygiene between patients", correct:"standard" },
      { id:"i2", text:"N95 respirator use", correct:"transmission" },
      { id:"i3", text:"Gloves for blood contact", correct:"standard" },
      { id:"i4", text:"Negative pressure room", correct:"transmission" },
      { id:"i5", text:"Safe sharps disposal", correct:"standard" }
    ];

    const pool = document.getElementById("pool");
    const bucketStandard = document.getElementById("bucketStandard");
    const bucketTransmission = document.getElementById("bucketTransmission");
    const zoneStandard = document.getElementById("zoneStandard");
    const zoneTransmission = document.getElementById("zoneTransmission");
    const checkActivity = document.getElementById("checkActivity");
    const fbAct = document.getElementById("fbAct");

    const placement = new Map(); // id -> "pool"|"standard"|"transmission"
    let draggingId = null;

    function makeItemEl(it){
      const el = document.createElement("div");
      el.className = "dndItem";
      el.setAttribute("data-item", it.id);
      el.setAttribute("draggable", "true");
      el.setAttribute("role","listitem");
      el.setAttribute("aria-label", it.text);

      const grip = document.createElement("div");
      grip.className = "grip";
      grip.setAttribute("aria-hidden","true");
      grip.textContent = "‚ãÆ‚ãÆ";

      const txt = document.createElement("div");
      txt.className = "dndText";
      txt.textContent = it.text;

      el.append(grip, txt);

      el.addEventListener("dragstart", (e)=>{
        draggingId = it.id;
        e.dataTransfer.effectAllowed = "move";
        try{ e.dataTransfer.setData("text/plain", it.id); }catch(_){}
        logInteraction("activity_dragstart", it.id, { from: placement.get(it.id) });
      });

      el.addEventListener("dragend", ()=>{
        draggingId = null;
        clearZoneHighlights();
      });

      return el;
    }

    function mountActivity(){
      pool.innerHTML = "";
      bucketStandard.innerHTML = "";
      bucketTransmission.innerHTML = "";
      actItems.forEach(it=>{
        placement.set(it.id, "pool");
        pool.append(makeItemEl(it));
      });
      state.activity.total = actItems.length;
      state.activity.placement = Object.fromEntries(placement.entries());
      saveState();
    }
    mountActivity();

    function moveTo(id, where){
      placement.set(id, where);
      const node = document.querySelector(`[data-item="${id}"]`);
      if(!node) return;

      if(where === "pool") pool.append(node);
      if(where === "standard") bucketStandard.append(node);
      if(where === "transmission") bucketTransmission.append(node);

      state.activity.placement = Object.fromEntries(placement.entries());
      saveState();
      logInteraction("activity_move", id, { to: where });
    }

    function setupDropZone(zoneEl, target){
      zoneEl.addEventListener("dragover", (e)=>{
        e.preventDefault();
        zoneEl.classList.add("dragOver");
        e.dataTransfer.dropEffect = "move";
      });
      zoneEl.addEventListener("dragleave", ()=>{
        zoneEl.classList.remove("dragOver");
      });
      zoneEl.addEventListener("drop", (e)=>{
        e.preventDefault();
        zoneEl.classList.remove("dragOver");
        const id = (e.dataTransfer && e.dataTransfer.getData("text/plain")) || draggingId;
        if(!id) return;
        moveTo(id, target);
        logInteraction("activity_drop", id, { to: target });
      });
    }

    function clearZoneHighlights(){
      zoneStandard.classList.remove("dragOver");
      zoneTransmission.classList.remove("dragOver");
    }

    setupDropZone(zoneStandard, "standard");
    setupDropZone(zoneTransmission, "transmission");

    checkActivity.addEventListener("click", ()=>{
      let correctCount = 0;
      actItems.forEach(it=>{
        if(placement.get(it.id) === it.correct) correctCount++;
      });

      state.activity.checked = true;
      state.activity.correctCount = correctCount;
      state.activity.placement = Object.fromEntries(placement.entries());
      saveState();

      fbAct.hidden = false;
      const ok = correctCount === actItems.length;
      fbAct.className = "feedback " + (ok ? "good" : "bad");
      fbAct.textContent = ok
        ? "Nice work ‚Äî all items are correctly classified."
        : `You classified ${correctCount}/${actItems.length} correctly. Review Standard vs Transmission-Based precautions and try again.`;

      logInteraction("activity_check", "classify", {
        correctCount, total: actItems.length,
        placement: Object.fromEntries(placement.entries())
      });
    });

    /***********************
     * Mark Complete
     ***********************/
    const markCompleteBtn = document.getElementById("markCompleteBtn");

    function canComplete(){
      return state.scrolledBottom && state.passed;
    }
    function updateStatusUI(){
      statusText.textContent = state.status;
      scoreText.textContent = Math.round(state.scoreRaw) + "%";
      markCompleteBtn.disabled = !canComplete();
      markCompleteBtn.style.opacity = canComplete() ? "1" : ".6";
      markCompleteBtn.style.cursor = canComplete() ? "pointer" : "not-allowed";
    }
    updateStatusUI();
    window.addEventListener("scroll", updateStatusUI);

    markCompleteBtn.addEventListener("click", ()=>{
      commitSectionTime(state.currentSection || "Intro");

      const totalMs = Object.values(state.sectionTimeMs).reduce((a,b)=>a+b,0);
      const scormTime = msToSCORMTime(totalMs);

      SCORM.setValue("cmi.core.session_time", scormTime);
      SCORM.setValue("cmi.core.score.raw", Math.round(state.scoreRaw));

      if(canComplete()){
        state.status = "completed";
        SCORM.setValue("cmi.core.lesson_status", "completed");
      }else{
        state.status = "incomplete";
        SCORM.setValue("cmi.core.lesson_status", "incomplete");
      }
      saveState();
      updateStatusUI();
      SCORM.commit();

      alert(canComplete()
        ? "Completed! Progress has been sent to the LMS."
        : "Not complete yet. Scroll to the bottom and pass the quiz (‚â•70%), then click Mark Complete.");
    });

    /***********************
     * Unload: commit time
     ***********************/
    window.addEventListener("beforeunload", ()=>{
      commitSectionTime(state.currentSection || "Intro");
      const totalMs = Object.values(state.sectionTimeMs).reduce((a,b)=>a+b,0);
      const scormTime = msToSCORMTime(totalMs);

      SCORM.setValue("cmi.core.session_time", scormTime);
      SCORM.setValue("cmi.core.score.raw", Math.round(state.scoreRaw));
      SCORM.setValue("cmi.core.lesson_status", state.status || "incomplete");
      SCORM.commit();
      SCORM.finish();
    });

    if(!state.currentSection){
      state.currentSection = "Intro";
      state.sectionEnteredAt = Date.now();
      saveState();
    }
    setCurrentNav(state.currentSection || "Intro");
  </script>
</body>
</html>
