/***********************
 * Activity Module 1 (Slide-in cards)
 * ✅ No Pool / Standard / Transmission move buttons
 * ✅ Cards open/close + slide in
 * ✅ Check enabled only when all cards answered
 ***********************/
const activityItems = [
  { id:"a1", text:"Perform hand hygiene after removing gloves", correct:"standard" },
  { id:"a2", text:"Wear gloves when anticipating contact with blood", correct:"standard" },
  { id:"a3", text:"Use an N95 respirator for airborne precautions when indicated", correct:"transmission" },
  { id:"a4", text:"Place patient in a negative pressure room when required", correct:"transmission" },
  { id:"a5", text:"Dispose of used sharps immediately in a sharps container", correct:"standard" }
];

const activityWrap = document.getElementById("activityCards");
const checkActivity = document.getElementById("checkActivity");
const fbAct = document.getElementById("fbAct");

// placement: id -> "standard"|"transmission"|null
state.activity = state.activity || { checked:false, correctCount:0, total:0, placement:{} };
state.activity.total = activityItems.length;
state.activity.placement = state.activity.placement || {};
saveState();

function setBtnEnabled(btn, enabled){
  if(!btn) return;
  btn.disabled = !enabled;
  btn.classList.toggle("is-enabled", enabled);
  btn.setAttribute("aria-disabled", String(!enabled));
}

function isActivityAnswered(){
  return activityItems.every(it => !!state.activity.placement[it.id]);
}

function refreshActivityButtonState(){
  setBtnEnabled(checkActivity, isActivityAnswered());
}

function iconChevron(){
  return `
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="m6 9 6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `;
}

function renderActivity(){
  if(!activityWrap) return;
  activityWrap.innerHTML = "";

  activityItems.forEach((it, idx) => {
    const chosen = state.activity.placement[it.id] || null;

    const card = document.createElement("div");
    card.className = "slideCard";
    card.dataset.item = it.id;

    const header = document.createElement("button");
    header.type = "button";
    header.className = "slideCardHeader";
    header.setAttribute("aria-expanded", "false");
    header.setAttribute("aria-controls", `body-${it.id}`);

    header.innerHTML = `
      <div class="left">
        <div class="slideIndex" aria-hidden="true">${idx+1}</div>
        <div style="min-width:0">
          <div class="slideTitle">${it.text}</div>
          <div class="slideMeta">${chosen ? "Answer selected" : "Select to answer"}</div>
        </div>
      </div>
      <div class="slideStatus">
        <span class="statusPill ${chosen ? "answered" : ""}">
          ${chosen ? (chosen === "standard" ? "Standard" : "Transmission") : "Not answered"}
        </span>
        <span class="chev" aria-hidden="true">${iconChevron()}</span>
      </div>
    `;

    const body = document.createElement("div");
    body.className = "slideBody";
    body.id = `body-${it.id}`;

    body.innerHTML = `
      <div class="slideBodyInner">
        <div class="choiceHint">Choose the best classification:</div>
        <div class="choiceRow" role="group" aria-label="Answer choices">
          <button type="button" class="choiceBtn ${chosen==="standard" ? "is-picked":""}" data-choice="standard">
            Standard Precaution
          </button>
          <button type="button" class="choiceBtn ${chosen==="transmission" ? "is-picked":""}" data-choice="transmission">
            Transmission-Based Precaution
          </button>
        </div>
      </div>
    `;

    header.addEventListener("click", ()=>{
      const open = card.classList.toggle("open");
      header.setAttribute("aria-expanded", String(open));
      logInteraction("activity_toggle", it.id, { open });
    });

    // Choice handling
    body.querySelectorAll(".choiceBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const choice = btn.dataset.choice;
        state.activity.placement[it.id] = choice;
        saveState();

        logInteraction("activity_answer", it.id, { choice });

        // collapse after choose (feels like your figma interactions)
        card.classList.remove("open");
        header.setAttribute("aria-expanded", "false");

        // rerender to update pills/states cleanly
        renderActivity();
        refreshActivityButtonState();
      });
    });

    card.append(header, body);
    activityWrap.append(card);
  });

  refreshActivityButtonState();
}

renderActivity();
refreshActivityButtonState();

if(checkActivity){
  // initially disabled until all answered
  refreshActivityButtonState();

  checkActivity.addEventListener("click", ()=>{
    if(checkActivity.disabled) return;

    let correctCount = 0;
    activityItems.forEach(it=>{
      if(state.activity.placement[it.id] === it.correct) correctCount++;
    });

    state.activity.checked = true;
    state.activity.correctCount = correctCount;
    saveState();

    const ok = correctCount === activityItems.length;
    fbAct.hidden = false;
    fbAct.className = "feedback " + (ok ? "good" : "bad");
    fbAct.textContent = ok
      ? "Nice work — all answers are correct."
      : `You got ${correctCount}/${activityItems.length} correct. Open the cards to review and adjust your selections.`;

    logInteraction("activity_check", "module1-slide-cards", {
      correctCount,
      total: activityItems.length,
      placement: state.activity.placement
    });
  });
}
